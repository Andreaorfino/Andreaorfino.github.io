<!DOCTYPE html>
<meta charset="utf-8">
<title>Modifying a force layout v4</title>

<style>
  .link {
    stroke: #999;
    stroke-width: 1px;
  }

</style>

<body>
  <svg width="2000" height="1000"></svg>

  <script src="//d3js.org/d3.v4.js"></script>
  <script>

    // genera un Hex color code che inizia con #0 (in modo che i colori siano tutti freddi)
    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color + "";
    }

    //genera un array di colori
    function getArrayColori(n) {
      let arrayColori = [];
      for (let i = 0; i < n; i++) {
        arrayColori.push(getRandomColor());
      }
      return arrayColori;
    }

    var circleCoord = function (circle, node, index, num_nodes) {
      var circumference = circle.node().getTotalLength();
      var pointAtLength = function (l) { return circle.node().getPointAtLength(l) };
      var sectionLength = (circumference) / num_nodes;
      var position = sectionLength * index + sectionLength / 2;
      return pointAtLength(circumference - position)
    }
    function getPosition(force) {
      return force.nodes().map(function (node) {
        return {
          name: node.name,
          group: node.group,
          x: node.x,
          y: node.y
        }
      })
    }

    function circle1(cx, cy, myr) {

      return "M" + cx + "," + cy + " " +
        "m" + -myr + ", 0 " +
        "a" + myr + "," + myr + " 0 1,0 " + myr * 2 + ",0 " +
        "a" + myr + "," + myr + " 0 1,0 " + -myr * 2 + ",0Z";
    }

    var svg = d3.select("svg");
    var width = svg.attr("width");
    var height = svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory10);

    var nodes = [],
      links = [];

    var graph = {
    "nodes": [
      { "name": "Myriel", "group": 1 },
      { "name": "Napoleon", "group": 1 },
      { "name": "Mlle.Baptistine", "group": 1 },
      { "name": "Mme.Magloire", "group": 1 },
      { "name": "CountessdeLo", "group": 1 },
      { "name": "Geborand", "group": 1 },
      { "name": "Champtercier", "group": 1 },
      { "name": "Cravatte", "group": 1 },
      { "name": "Count", "group": 1 },
      { "name": "OldMan", "group": 1 },
      { "name": "Labarre", "group": 2 },
      { "name": "Valjean", "group": 2 },
      { "name": "Marguerite", "group": 3 },
      { "name": "Mme.deR", "group": 2 },
      { "name": "Isabeau", "group": 2 },
      { "name": "Gervais", "group": 2 },
      { "name": "Tholomyes", "group": 3 },
      { "name": "Listolier", "group": 3 },
      { "name": "Fameuil", "group": 3 },
      { "name": "Blacheville", "group": 3 },
      { "name": "Favourite", "group": 3 },
      { "name": "Dahlia", "group": 3 },
      { "name": "Zephine", "group": 3 },
      { "name": "Fantine", "group": 3 },
      { "name": "Tholomyes1", "group": 3 },
      { "name": "Listolier1", "group": 3 },
      { "name": "Fameuil1", "group": 3 },
      { "name": "Blacheville1", "group": 3 },
      { "name": "Favourite1", "group": 3 },
      { "name": "Dahlia1", "group": 3 },
      { "name": "Zephine1", "group": 3 },
      { "name": "Fantine1", "group": 3 },
      { "name": "Tholomyes2", "group": 3 },
      { "name": "Listolier2", "group": 3 },
      { "name": "Fameuil2", "group": 3 },
      { "name": "Blacheville2", "group": 3 },
      { "name": "Favourite2", "group": 3 },
      { "name": "Dahlia2", "group": 3 },
      { "name": "Zephine2", "group": 3 },
      { "name": "Fantine2", "group": 3 },
      { "name": "Tholomyes3", "group": 3 },
      { "name": "Listolier3", "group": 3 },
      { "name": "Fameuil3", "group": 3 },
      { "name": "Blacheville3", "group": 3 },
      { "name": "Favourite3", "group": 3 },
      { "name": "Dahlia3", "group": 3 },
      { "name": "Zephine3", "group": 3 },
      { "name": "Fantine3", "group": 3 }
      
    ],
    "links": [
      { "source": "Napoleon", "target": "Myriel", "value": 1 },
      { "source": "Mlle.Baptistine", "target": "Myriel", "value": 8 },
      { "source": "Mme.Magloire", "target": "Myriel", "value": 10 },
      { "source": "Mme.Magloire", "target": "Mlle.Baptistine", "value": 6 },
      { "source": "CountessdeLo", "target": "Myriel", "value": 1 },
      { "source": "Geborand", "target": "Myriel", "value": 1 },
      { "source": "Champtercier", "target": "Myriel", "value": 1 },
      { "source": "Cravatte", "target": "Myriel", "value": 1 },
      { "source": "Count", "target": "Myriel", "value": 2 },
      { "source": "OldMan", "target": "Myriel", "value": 1 },
      { "source": "Valjean", "target": "Labarre", "value": 1 },
      { "source": "Valjean", "target": "Mme.Magloire", "value": 3 },
      { "source": "Valjean", "target": "Mlle.Baptistine", "value": 3 },
      { "source": "Valjean", "target": "Myriel", "value": 5 },
      { "source": "Marguerite", "target": "Valjean", "value": 1 },
      { "source": "Mme.deR", "target": "Valjean", "value": 1 },
      { "source": "Isabeau", "target": "Valjean", "value": 1 },
      { "source": "Gervais", "target": "Valjean", "value": 1 },
      { "source": "Listolier", "target": "Tholomyes", "value": 4 },
      { "source": "Fameuil", "target": "Tholomyes", "value": 4 },
      { "source": "Fameuil", "target": "Listolier", "value": 4 },
      { "source": "Blacheville", "target": "Tholomyes", "value": 4 },
      { "source": "Blacheville", "target": "Listolier", "value": 4 },
      { "source": "Blacheville", "target": "Fameuil", "value": 4 },
      { "source": "Favourite", "target": "Tholomyes", "value": 3 },
      { "source": "Favourite", "target": "Listolier", "value": 3 },
      { "source": "Favourite", "target": "Fameuil", "value": 3 },
      { "source": "Favourite", "target": "Blacheville", "value": 4 },
      { "source": "Dahlia", "target": "Tholomyes", "value": 3 },
      { "source": "Dahlia", "target": "Listolier", "value": 3 },
      { "source": "Dahlia", "target": "Fameuil", "value": 3 },
      { "source": "Dahlia", "target": "Blacheville", "value": 3 },
      { "source": "Dahlia", "target": "Favourite", "value": 5 },
      { "source": "Zephine", "target": "Tholomyes", "value": 3 },
      { "source": "Zephine", "target": "Listolier", "value": 3 },
      { "source": "Zephine", "target": "Fameuil", "value": 3 },
      { "source": "Zephine", "target": "Blacheville", "value": 3 },
      { "source": "Zephine", "target": "Favourite", "value": 4 },
      { "source": "Zephine", "target": "Dahlia", "value": 4 },
      { "source": "Fantine", "target": "Tholomyes", "value": 3 },
      { "source": "Fantine", "target": "Listolier", "value": 3 },
      { "source": "Fantine", "target": "Fameuil", "value": 3 },
      { "source": "Fantine", "target": "Blacheville", "value": 3 },
      { "source": "Fantine", "target": "Favourite", "value": 4 },
      { "source": "Fantine", "target": "Dahlia", "value": 4 },
      { "source": "Fantine", "target": "Zephine", "value": 4 },
      { "source": "Fantine", "target": "Marguerite", "value": 2 },
      { "source": "Fantine", "target": "Valjean", "value": 9 },
      
    ]
  }



      ;



    var simulation = d3.forceSimulation()
      .force("link", d3.forceLink().distance(200).strength(.6).id(function (d) {
        return d.name;
      }).distance(function (d) {
        if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return -20; }
        else {
          if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
            return 20;
          } else {
            if (d.source.group == d.target.group) { return 0; } else {
              return 0;
            }
          }
        }
      })
        .strength(function (d) {
          if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.3; }
          else {
            if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
              return 0;
            } else {
              if (d.source.group == d.target.group) { return 0 } else {
                return 0;
              }
            }
          }
        }))
      .force("charge", d3.forceManyBody())
      .force("x", d3.forceX(width / 2))
      .force("y", d3.forceY(height / 2))
      .force('collision', d3.forceCollide().radius(function (d) { ; if (d.name.includes("invisibile")) return 200; else return 40; }))
      .on("tick", ticked);




    var cluster_name = [];
    graph.nodes.forEach(function (d) {
      cluster_name.push(d.group);
    })
    var unique_cluster_name = [...new Set(cluster_name)];
    var lista_nodi_invisibili = unique_cluster_name.map(d => {
      return { "name": "invisibile" + d, "group": d };
    });
    /*     lista_nodi_invisibili=[{ "name": "invisibile" + 1, "group": 1 },{ "name": "invisibile" + 2, "group": 2 }] */

    allNodes = graph.nodes.map(node => {
      return createNode(node.name, node.group)
    })

    nodes = lista_nodi_invisibili.map(node => {
      return createNode(node.name, node.group)
    })



    var colori_array = getArrayColori(unique_cluster_name.length);

    var a = createNode('A', 100);

    start();

    function getIndexGroup(groups, d) {
      for (let i = 0; i < groups.length; i++) {
        if (groups[i].key == d) return groups[i];
      }
    }

    function decisiNumeroNodiInvisibili (n) {
      return Math.floor(Math.log(n+2.7)*20)
    /* if (n<4) return 30;
    else if (n<7) return 40;
    else if (n<12) return 60;
    else return 80; */
  } 

    var groups = d3.nest().key(function (d) { return d.group; }).entries(graph.nodes);

    setTimeout(function () {
      var coordinateCentroNodiPosizione = simulation.nodes().map(function (d) {
        return [d.x, d.y, d.group];
      })



      coordinateCentroNodiPosizione.forEach(function (d) {
        var x = d[0];
        var y = d[1];
        var j = d[2];

      const gruppo = getIndexGroup(groups,j)


        var nNodiGroupCluster = decisiNumeroNodiInvisibili(gruppo.values.length);

        var pathCircle = circle1(x, y, nNodiGroupCluster * 1.5);
        var circle = svg.append("path")
          .attr("d", pathCircle)
          .style("fill", "#f5f5f5")
          .style("opacity", 0.5);
        var length = circle.node().getTotalLength();
        for (i = 0; i < nNodiGroupCluster; i++) {
          nodo = createNode(String(i) + 'groupCluster' + String(j), 100);
          var coord = circleCoord(circle, nodo, i, nNodiGroupCluster)
          nodo.x = coord.x
          nodo.y = coord.y
          nodes.push(...[nodo])
          if (i > 0) {
            var link = { source: String(i - 1) + 'groupCluster' + String(j), target: String(i) + 'groupCluster' + String(j) }
            links.push(...[link])
          }
          if (i == nNodiGroupCluster - 1) {
            var link2 = { source: String(i) + 'groupCluster' + String(j), target: String(0) + 'groupCluster' + String(j) }
            links.push(...[link2])
          }
        };
        circle.remove();
      })

      simulation
        .force(
          "link",
          d3.forceLink()
            .id(function (d) {
              return d.name;
            })
            .distance(function (d) {
              if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return -100; }
              else {
                if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
                  return 100;
                } else {
                  if (d.source.group == d.target.group) { return -100; } else {
                    return 0;
                  }
                }
              }
            })
            .strength(function (d) {
              if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.2; }
              else {
                if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
                  return 0.6;
                } else {
                  if ((d.source.group == d.target.group) && (d.source.name.includes('groupCluster'))) { return 2 } else {
                    return 0;
                  }
                }
              }
            }))

        // use forceX and forceY instead to change the relative positioning
        // .force("centering", d3.forceCenter(width/2, height/2))
        .force("charge", d3.forceManyBody().strength(function (d) {
          if (d.name.includes("groupCluster")) return -50; else return 0;
        }))
        .force('collision', d3.forceCollide().radius(function (d) { if (d.name.includes("groupCluster")) return 8; else return 10; }))
        .on("tick", ticked);
      //nodes.push(...[a]);
      start();
    }, 1000);

    function getNodeGroup(group, listaNodi) {
      for (var i = 0; i < listaNodi.length; i++) {
        if (listaNodi[i].group == group) { return listaNodi[i]; }
      }
    }

    setTimeout(function () {
      var coordinateCentroNodiPosizione = [];
      simulation.nodes().forEach(function (d) {
        if (d.name.includes("invisibile")) {
          coordinateCentroNodiPosizione.push({ x: d.x, y: d.y, group: d.group });
        }
      });



      graph.nodes.forEach(d => {
        const centro = getNodeGroup(d.group, coordinateCentroNodiPosizione);
        const offset = 40;
        d.x = centro.x + (Math.random() * offset);
        d.y = centro.y + (Math.random() * offset);

        nodes.push(d);
      })

      links.push(...graph.links)

/*       d3.range(50).forEach(function (d) {
        var ny = coordinateCentroNodiPosizione[0].y + (Math.random() * 5);
        var nx = coordinateCentroNodiPosizione[0].x + (Math.random() * 5);
        nodes.push({ name: String(d), group: 0, x: nx, y: ny });
      }) */

      start2();
    }, 4000);

    /*     setTimeout(function () {
          // remove b
          nodes.push(...[a]);
          start();
        }, 1000);
    
        // 1. add the links
        setTimeout(function () {
          nodes.push(...allNodes);
          links.push(...graph.links);
          start();
    
        }, 3000); */
    /*
        // 2. Remove node B and associated links.
        setTimeout(function () {
          // remove b
          nodes = [a, c];
          // remove a-b
          links = [links[1]];
          start();
        }, 2000);
    
    
        // Add node B back.
        setTimeout(function () {
          b = createNode("b")
          nodes.push(b);
          links.push({ source: a, target: b }, { source: b, target: c });
          start();
        }, 3000); */

    function createNode(nome, group) {
      return { "name": nome, "x": width / 2, "y": height / 2, group }
    }

    var fase2=false;

    function start() {

      var nodeElements = svg.selectAll(".node").data(nodes, function (d) { return d.id });


      nodeElements.enter()
        .append("circle")
        .attr("class", function (d) { return "node " + d.id; })
        .attr("r", function (d) {
          if (d.name.includes("invisibile")) {
            return 10;
          } else if (d.name == 'A') {
            return 20;
          } else {
            return 8
          }
        })
        .attr("fill", function (d) { if (d.name.includes("invisibile")) return "red"; else return colori_array[d.group] })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

      nodeElements.exit().remove();

      var linkElements = svg.selectAll(".link").data(links);
      linkElements.enter().insert("line", ".node").attr("class", "link");
      linkElements.exit().remove();

      simulation.nodes(nodes)
      simulation.force("link").links(links)
      simulation.restart();
    }

    function start2() {


      var nodeElements = svg.selectAll(".node").data(nodes, function (d) { return d.id });


      nodeElements.enter()
        .append("circle")
        .attr("class", function (d) { return "node " + d.id; })
        .attr("r", function (d) {
          if (d.name.includes("invisibile")) {
            return 10;
          } else if (d.name == 'A') {
            return 20;
          } else {
            return 8
          }
        })
        .attr("fill", function (d) { if (d.name.includes("invisibile")) return "red"; else return colori_array[d.group] })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

      nodeElements.exit().remove();

      var linkElements = svg.selectAll(".link").data(links);
      linkElements.enter().insert("line", ".node").attr("class", "link");
      linkElements.exit().remove();

      simulation.nodes(nodes)
      simulation.force("link").links(links)
      simulation.restart();
    }

    /*     function tick() {
          var nodeElements = svg.selectAll(".node");
          var linkElements = svg.selectAll(".link");
    
          nodeElements.attr("cx", function (d, i) { return d.x; })
            .attr("cy", function (d) { return d.y; })
    
          linkElements.attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });
    
    
        } */

    function ticked() {

      var nodeElements = svg.selectAll(".node");
      var linkElements = svg.selectAll(".link");

      nodeElements.attr("cx", function (d) {
        if (d.name.includes("groupCluster")) {
          return d.x
        }
        return d.x = Math.max(50, Math.min(width - 50, d.x));
      })
        .attr("cy", function (d) {
          if (d.name.includes("groupCluster")) {
            return d.y
          }
          return d.y = Math.max(50, Math.min(height - 50, d.y));
        });

      linkElements.attr("x1", function (d) { return d.source.x; })
        .attr("y1", function (d) { return d.source.y; })
        .attr("x2", function (d) { return d.target.x; })
        .attr("y2", function (d) { return d.target.y; });
    }

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

  </script>
