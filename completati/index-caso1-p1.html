<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <style>
    .links line {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .link {
      stroke: #999;
      stroke-width: 1px;
    }
  </style>
</head>
<div id="comandi">
  


</div>

  <form id="grafo">
    <input type="radio" name="grafo" value="1" checked="checked">grafo 1
    <input type="radio" name="grafo" value="2">grafo 2
    <input type="radio" name="grafo" value="3">grafo 3
  </form>


<div id="contenitore">
  <svg></svg>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

  //intialize data
  var graph = {
    "nodes": [
      { "name": "Myriel", "group": 1 },
      { "name": "Napoleon", "group": 1 },
      { "name": "Mlle.Baptistine", "group": 1 },
      { "name": "Mme.Magloire", "group": 1 },
      { "name": "CountessdeLo", "group": 1 },
      { "name": "Geborand", "group": 1 },
      { "name": "Champtercier", "group": 1 },
      { "name": "Cravatte", "group": 1 },
      { "name": "Count", "group": 1 },
      { "name": "OldMan", "group": 1 },
      { "name": "Labarre", "group": 2 },
      { "name": "Valjean", "group": 2 },
      { "name": "Marguerite", "group": 3 },
      { "name": "Mme.deR", "group": 2 },
      { "name": "Isabeau", "group": 2 },
      { "name": "Gervais", "group": 2 },
      { "name": "Tholomyes", "group": 3 },
      { "name": "Listolier", "group": 3 },
      { "name": "Fameuil", "group": 3 },
      { "name": "Blacheville", "group": 3 },
      { "name": "Favourite", "group": 3 },
      { "name": "Dahlia", "group": 3 },
      { "name": "Zephine", "group": 3 },
      { "name": "Fantine", "group": 3 },
      { "name": "Mme.Thenardier", "group": 4 },
      { "name": "Thenardier", "group": 4 },
      { "name": "Cosette", "group": 5 },
      { "name": "Javert", "group": 4 },
      { "name": "Fauchelevent", "group": 0 },
      { "name": "Bamatabois", "group": 2 },
      { "name": "Perpetue", "group": 3 },
      { "name": "Simplice", "group": 2 },
      { "name": "Scaufflaire", "group": 2 },
      { "name": "Woman1", "group": 2 },
      { "name": "Judge", "group": 2 },
      { "name": "Champmathieu", "group": 2 },
      { "name": "Brevet", "group": 2 },
      { "name": "Chenildieu", "group": 2 },
      { "name": "Cochepaille", "group": 2 },
      { "name": "Pontmercy", "group": 4 },
      { "name": "Boulatruelle", "group": 6 },
      { "name": "Eponine", "group": 4 },
      { "name": "Anzelma", "group": 4 },
      { "name": "Woman2", "group": 5 },
      { "name": "MotherInnocent", "group": 0 },
      { "name": "Gribier", "group": 0 },
      { "name": "Jondrette", "group": 7 },
      { "name": "Mme.Burgon", "group": 7 },
      { "name": "Gavroche", "group": 8 },
      { "name": "Gillenormand", "group": 5 },
      { "name": "Magnon", "group": 5 },
      { "name": "Mlle.Gillenormand", "group": 5 },
      { "name": "Mme.Pontmercy", "group": 5 },
      { "name": "Mlle.Vaubois", "group": 5 },
      { "name": "Lt.Gillenormand", "group": 5 },
      { "name": "Marius", "group": 8 },
      { "name": "BaronessT", "group": 5 },
      { "name": "Mabeuf", "group": 8 },
      { "name": "Enjolras", "group": 8 },
      { "name": "Combeferre", "group": 8 },
      { "name": "Prouvaire", "group": 8 },
      { "name": "Feuilly", "group": 8 },
      { "name": "Courfeyrac", "group": 8 },
      { "name": "Bahorel", "group": 8 },
      { "name": "Bossuet", "group": 8 },
      { "name": "Joly", "group": 8 },
      { "name": "Grantaire", "group": 8 },
      { "name": "MotherPlutarch", "group": 9 },
      { "name": "Gueulemer", "group": 4 },
      { "name": "Babet", "group": 4 },
      { "name": "Claquesous", "group": 4 },
      { "name": "Montparnasse", "group": 4 },
      { "name": "Toussaint", "group": 5 },
      { "name": "Child1", "group": 10 },
      { "name": "Child2", "group": 10 },
      { "name": "Brujon", "group": 4 },
      { "name": "Mme.Hucheloup", "group": 8 }
    ],
    "links": [
      { "source": "Napoleon", "target": "Myriel", "value": 1 },
      { "source": "Mlle.Baptistine", "target": "Myriel", "value": 8 },
      { "source": "Mme.Magloire", "target": "Myriel", "value": 10 },
      { "source": "Mme.Magloire", "target": "Mlle.Baptistine", "value": 6 },
      { "source": "CountessdeLo", "target": "Myriel", "value": 1 },
      { "source": "Geborand", "target": "Myriel", "value": 1 },
      { "source": "Champtercier", "target": "Myriel", "value": 1 },
      { "source": "Cravatte", "target": "Myriel", "value": 1 },
      { "source": "Count", "target": "Myriel", "value": 2 },
      { "source": "OldMan", "target": "Myriel", "value": 1 },
      { "source": "Valjean", "target": "Labarre", "value": 1 },
      { "source": "Valjean", "target": "Mme.Magloire", "value": 3 },
      { "source": "Valjean", "target": "Mlle.Baptistine", "value": 3 },
      { "source": "Valjean", "target": "Myriel", "value": 5 },
      { "source": "Marguerite", "target": "Valjean", "value": 1 },
      { "source": "Mme.deR", "target": "Valjean", "value": 1 },
      { "source": "Isabeau", "target": "Valjean", "value": 1 },
      { "source": "Gervais", "target": "Valjean", "value": 1 },
      { "source": "Listolier", "target": "Tholomyes", "value": 4 },
      { "source": "Fameuil", "target": "Tholomyes", "value": 4 },
      { "source": "Fameuil", "target": "Listolier", "value": 4 },
      { "source": "Blacheville", "target": "Tholomyes", "value": 4 },
      { "source": "Blacheville", "target": "Listolier", "value": 4 },
      { "source": "Blacheville", "target": "Fameuil", "value": 4 },
      { "source": "Favourite", "target": "Tholomyes", "value": 3 },
      { "source": "Favourite", "target": "Listolier", "value": 3 },
      { "source": "Favourite", "target": "Fameuil", "value": 3 },
      { "source": "Favourite", "target": "Blacheville", "value": 4 },
      { "source": "Dahlia", "target": "Tholomyes", "value": 3 },
      { "source": "Dahlia", "target": "Listolier", "value": 3 },
      { "source": "Dahlia", "target": "Fameuil", "value": 3 },
      { "source": "Dahlia", "target": "Blacheville", "value": 3 },
      { "source": "Dahlia", "target": "Favourite", "value": 5 },
      { "source": "Zephine", "target": "Tholomyes", "value": 3 },
      { "source": "Zephine", "target": "Listolier", "value": 3 },
      { "source": "Zephine", "target": "Fameuil", "value": 3 },
      { "source": "Zephine", "target": "Blacheville", "value": 3 },
      { "source": "Zephine", "target": "Favourite", "value": 4 },
      { "source": "Zephine", "target": "Dahlia", "value": 4 },
      { "source": "Fantine", "target": "Tholomyes", "value": 3 },
      { "source": "Fantine", "target": "Listolier", "value": 3 },
      { "source": "Fantine", "target": "Fameuil", "value": 3 },
      { "source": "Fantine", "target": "Blacheville", "value": 3 },
      { "source": "Fantine", "target": "Favourite", "value": 4 },
      { "source": "Fantine", "target": "Dahlia", "value": 4 },
      { "source": "Fantine", "target": "Zephine", "value": 4 },
      { "source": "Fantine", "target": "Marguerite", "value": 2 },
      { "source": "Fantine", "target": "Valjean", "value": 9 },
      { "source": "Mme.Thenardier", "target": "Fantine", "value": 2 },
      { "source": "Mme.Thenardier", "target": "Valjean", "value": 7 },
      { "source": "Thenardier", "target": "Mme.Thenardier", "value": 13 },
      { "source": "Thenardier", "target": "Fantine", "value": 1 },
      { "source": "Thenardier", "target": "Valjean", "value": 12 },
      { "source": "Cosette", "target": "Mme.Thenardier", "value": 4 },
      { "source": "Cosette", "target": "Valjean", "value": 31 },
      { "source": "Cosette", "target": "Tholomyes", "value": 1 },
      { "source": "Cosette", "target": "Thenardier", "value": 1 },
      { "source": "Javert", "target": "Valjean", "value": 17 },
      { "source": "Javert", "target": "Fantine", "value": 5 },
      { "source": "Javert", "target": "Thenardier", "value": 5 },
      { "source": "Javert", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Javert", "target": "Cosette", "value": 1 },
      { "source": "Fauchelevent", "target": "Valjean", "value": 8 },
      { "source": "Fauchelevent", "target": "Javert", "value": 1 },
      { "source": "Bamatabois", "target": "Fantine", "value": 1 },
      { "source": "Bamatabois", "target": "Javert", "value": 1 },
      { "source": "Bamatabois", "target": "Valjean", "value": 2 },
      { "source": "Perpetue", "target": "Fantine", "value": 1 },
      { "source": "Simplice", "target": "Perpetue", "value": 2 },
      { "source": "Simplice", "target": "Valjean", "value": 3 },
      { "source": "Simplice", "target": "Fantine", "value": 2 },
      { "source": "Simplice", "target": "Javert", "value": 1 },
      { "source": "Scaufflaire", "target": "Valjean", "value": 1 },
      { "source": "Woman1", "target": "Valjean", "value": 2 },
      { "source": "Woman1", "target": "Javert", "value": 1 },
      { "source": "Judge", "target": "Valjean", "value": 3 },
      { "source": "Judge", "target": "Bamatabois", "value": 2 },
      { "source": "Champmathieu", "target": "Valjean", "value": 3 },
      { "source": "Champmathieu", "target": "Judge", "value": 3 },
      { "source": "Champmathieu", "target": "Bamatabois", "value": 2 },
      { "source": "Brevet", "target": "Judge", "value": 2 },
      { "source": "Brevet", "target": "Champmathieu", "value": 2 },
      { "source": "Brevet", "target": "Valjean", "value": 2 },
      { "source": "Brevet", "target": "Bamatabois", "value": 1 },
      { "source": "Chenildieu", "target": "Judge", "value": 2 },
      { "source": "Chenildieu", "target": "Champmathieu", "value": 2 },
      { "source": "Chenildieu", "target": "Brevet", "value": 2 },
      { "source": "Chenildieu", "target": "Valjean", "value": 2 },
      { "source": "Chenildieu", "target": "Bamatabois", "value": 1 },
      { "source": "Cochepaille", "target": "Judge", "value": 2 },
      { "source": "Cochepaille", "target": "Champmathieu", "value": 2 },
      { "source": "Cochepaille", "target": "Brevet", "value": 2 },
      { "source": "Cochepaille", "target": "Chenildieu", "value": 2 },
      { "source": "Cochepaille", "target": "Valjean", "value": 2 },
      { "source": "Cochepaille", "target": "Bamatabois", "value": 1 },
      { "source": "Pontmercy", "target": "Thenardier", "value": 1 },
      { "source": "Boulatruelle", "target": "Thenardier", "value": 1 },
      { "source": "Eponine", "target": "Mme.Thenardier", "value": 2 },
      { "source": "Eponine", "target": "Thenardier", "value": 3 },
      { "source": "Anzelma", "target": "Eponine", "value": 2 },
      { "source": "Anzelma", "target": "Thenardier", "value": 2 },
      { "source": "Anzelma", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Woman2", "target": "Valjean", "value": 3 },
      { "source": "Woman2", "target": "Cosette", "value": 1 },
      { "source": "Woman2", "target": "Javert", "value": 1 },
      { "source": "MotherInnocent", "target": "Fauchelevent", "value": 3 },
      { "source": "MotherInnocent", "target": "Valjean", "value": 1 },
      { "source": "Gribier", "target": "Fauchelevent", "value": 2 },
      { "source": "Mme.Burgon", "target": "Jondrette", "value": 1 },
      { "source": "Gavroche", "target": "Mme.Burgon", "value": 2 },
      { "source": "Gavroche", "target": "Thenardier", "value": 1 },
      { "source": "Gavroche", "target": "Javert", "value": 1 },
      { "source": "Gavroche", "target": "Valjean", "value": 1 },
      { "source": "Gillenormand", "target": "Cosette", "value": 3 },
      { "source": "Gillenormand", "target": "Valjean", "value": 2 },
      { "source": "Magnon", "target": "Gillenormand", "value": 1 },
      { "source": "Magnon", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Mlle.Gillenormand", "target": "Gillenormand", "value": 9 },
      { "source": "Mlle.Gillenormand", "target": "Cosette", "value": 2 },
      { "source": "Mlle.Gillenormand", "target": "Valjean", "value": 2 },
      { "source": "Mme.Pontmercy", "target": "Mlle.Gillenormand", "value": 1 },
      { "source": "Mme.Pontmercy", "target": "Pontmercy", "value": 1 },
      { "source": "Mlle.Vaubois", "target": "Mlle.Gillenormand", "value": 1 },
      { "source": "Lt.Gillenormand", "target": "Mlle.Gillenormand", "value": 2 },
      { "source": "Lt.Gillenormand", "target": "Gillenormand", "value": 1 },
      { "source": "Lt.Gillenormand", "target": "Cosette", "value": 1 },
      { "source": "Marius", "target": "Mlle.Gillenormand", "value": 6 },
      { "source": "Marius", "target": "Gillenormand", "value": 12 },
      { "source": "Marius", "target": "Pontmercy", "value": 1 },
      { "source": "Marius", "target": "Lt.Gillenormand", "value": 1 },
      { "source": "Marius", "target": "Cosette", "value": 21 },
      { "source": "Marius", "target": "Valjean", "value": 19 },
      { "source": "Marius", "target": "Tholomyes", "value": 1 },
      { "source": "Marius", "target": "Thenardier", "value": 2 },
      { "source": "Marius", "target": "Eponine", "value": 5 },
      { "source": "Marius", "target": "Gavroche", "value": 4 },
      { "source": "BaronessT", "target": "Gillenormand", "value": 1 },
      { "source": "BaronessT", "target": "Marius", "value": 1 },
      { "source": "Mabeuf", "target": "Marius", "value": 1 },
      { "source": "Mabeuf", "target": "Eponine", "value": 1 },
      { "source": "Mabeuf", "target": "Gavroche", "value": 1 },
      { "source": "Enjolras", "target": "Marius", "value": 7 },
      { "source": "Enjolras", "target": "Gavroche", "value": 7 },
      { "source": "Enjolras", "target": "Javert", "value": 6 },
      { "source": "Enjolras", "target": "Mabeuf", "value": 1 },
      { "source": "Enjolras", "target": "Valjean", "value": 4 },
      { "source": "Combeferre", "target": "Enjolras", "value": 15 },
      { "source": "Combeferre", "target": "Marius", "value": 5 },
      { "source": "Combeferre", "target": "Gavroche", "value": 6 },
      { "source": "Combeferre", "target": "Mabeuf", "value": 2 },
      { "source": "Prouvaire", "target": "Gavroche", "value": 1 },
      { "source": "Prouvaire", "target": "Enjolras", "value": 4 },
      { "source": "Prouvaire", "target": "Combeferre", "value": 2 },
      { "source": "Feuilly", "target": "Gavroche", "value": 2 },
      { "source": "Feuilly", "target": "Enjolras", "value": 6 },
      { "source": "Feuilly", "target": "Prouvaire", "value": 2 },
      { "source": "Feuilly", "target": "Combeferre", "value": 5 },
      { "source": "Feuilly", "target": "Mabeuf", "value": 1 },
      { "source": "Feuilly", "target": "Marius", "value": 1 },
      { "source": "Courfeyrac", "target": "Marius", "value": 9 },
      { "source": "Courfeyrac", "target": "Enjolras", "value": 17 },
      { "source": "Courfeyrac", "target": "Combeferre", "value": 13 },
      { "source": "Courfeyrac", "target": "Gavroche", "value": 7 },
      { "source": "Courfeyrac", "target": "Mabeuf", "value": 2 },
      { "source": "Courfeyrac", "target": "Eponine", "value": 1 },
      { "source": "Courfeyrac", "target": "Feuilly", "value": 6 },
      { "source": "Courfeyrac", "target": "Prouvaire", "value": 3 },
      { "source": "Bahorel", "target": "Combeferre", "value": 5 },
      { "source": "Bahorel", "target": "Gavroche", "value": 5 },
      { "source": "Bahorel", "target": "Courfeyrac", "value": 6 },
      { "source": "Bahorel", "target": "Mabeuf", "value": 2 },
      { "source": "Bahorel", "target": "Enjolras", "value": 4 },
      { "source": "Bahorel", "target": "Feuilly", "value": 3 },
      { "source": "Bahorel", "target": "Prouvaire", "value": 2 },
      { "source": "Bahorel", "target": "Marius", "value": 1 },
      { "source": "Bossuet", "target": "Marius", "value": 5 },
      { "source": "Bossuet", "target": "Courfeyrac", "value": 12 },
      { "source": "Bossuet", "target": "Gavroche", "value": 5 },
      { "source": "Bossuet", "target": "Bahorel", "value": 4 },
      { "source": "Bossuet", "target": "Enjolras", "value": 10 },
      { "source": "Bossuet", "target": "Feuilly", "value": 6 },
      { "source": "Bossuet", "target": "Prouvaire", "value": 2 },
      { "source": "Bossuet", "target": "Combeferre", "value": 9 },
      { "source": "Bossuet", "target": "Mabeuf", "value": 1 },
      { "source": "Bossuet", "target": "Valjean", "value": 1 },
      { "source": "Joly", "target": "Bahorel", "value": 5 },
      { "source": "Joly", "target": "Bossuet", "value": 7 },
      { "source": "Joly", "target": "Gavroche", "value": 3 },
      { "source": "Joly", "target": "Courfeyrac", "value": 5 },
      { "source": "Joly", "target": "Enjolras", "value": 5 },
      { "source": "Joly", "target": "Feuilly", "value": 5 },
      { "source": "Joly", "target": "Prouvaire", "value": 2 },
      { "source": "Joly", "target": "Combeferre", "value": 5 },
      { "source": "Joly", "target": "Mabeuf", "value": 1 },
      { "source": "Joly", "target": "Marius", "value": 2 },
      { "source": "Grantaire", "target": "Bossuet", "value": 3 },
      { "source": "Grantaire", "target": "Enjolras", "value": 3 },
      { "source": "Grantaire", "target": "Combeferre", "value": 1 },
      { "source": "Grantaire", "target": "Courfeyrac", "value": 2 },
      { "source": "Grantaire", "target": "Joly", "value": 2 },
      { "source": "Grantaire", "target": "Gavroche", "value": 1 },
      { "source": "Grantaire", "target": "Bahorel", "value": 1 },
      { "source": "Grantaire", "target": "Feuilly", "value": 1 },
      { "source": "Grantaire", "target": "Prouvaire", "value": 1 },
      //{"source": "MotherPlutarch", "target": "Mabeuf", "value": 3},
      { "source": "Gueulemer", "target": "Thenardier", "value": 5 },
      { "source": "Gueulemer", "target": "Valjean", "value": 1 },
      { "source": "Gueulemer", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Gueulemer", "target": "Javert", "value": 1 },
      { "source": "Gueulemer", "target": "Gavroche", "value": 1 },
      { "source": "Gueulemer", "target": "Eponine", "value": 1 },
      { "source": "Babet", "target": "Thenardier", "value": 6 },
      { "source": "Babet", "target": "Gueulemer", "value": 6 },
      { "source": "Babet", "target": "Valjean", "value": 1 },
      { "source": "Babet", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Babet", "target": "Javert", "value": 2 },
      { "source": "Babet", "target": "Gavroche", "value": 1 },
      { "source": "Babet", "target": "Eponine", "value": 1 },
      { "source": "Claquesous", "target": "Thenardier", "value": 4 },
      { "source": "Claquesous", "target": "Babet", "value": 4 },
      { "source": "Claquesous", "target": "Gueulemer", "value": 4 },
      { "source": "Claquesous", "target": "Valjean", "value": 1 },
      { "source": "Claquesous", "target": "Mme.Thenardier", "value": 1 },
      { "source": "Claquesous", "target": "Javert", "value": 1 },
      { "source": "Claquesous", "target": "Eponine", "value": 1 },
      { "source": "Claquesous", "target": "Enjolras", "value": 1 },
      { "source": "Montparnasse", "target": "Javert", "value": 1 },
      { "source": "Montparnasse", "target": "Babet", "value": 2 },
      { "source": "Montparnasse", "target": "Gueulemer", "value": 2 },
      { "source": "Montparnasse", "target": "Claquesous", "value": 2 },
      { "source": "Montparnasse", "target": "Valjean", "value": 1 },
      { "source": "Montparnasse", "target": "Gavroche", "value": 1 },
      { "source": "Montparnasse", "target": "Eponine", "value": 1 },
      { "source": "Montparnasse", "target": "Thenardier", "value": 1 },
      { "source": "Toussaint", "target": "Cosette", "value": 2 },
      { "source": "Toussaint", "target": "Javert", "value": 1 },
      { "source": "Toussaint", "target": "Valjean", "value": 1 },
      { "source": "Child1", "target": "Gavroche", "value": 2 },
      { "source": "Child2", "target": "Gavroche", "value": 2 },
      { "source": "Child2", "target": "Child1", "value": 3 },
      { "source": "Brujon", "target": "Babet", "value": 3 },
      { "source": "Brujon", "target": "Gueulemer", "value": 3 },
      { "source": "Brujon", "target": "Thenardier", "value": 3 },
      { "source": "Brujon", "target": "Gavroche", "value": 1 },
      { "source": "Brujon", "target": "Eponine", "value": 1 },
      { "source": "Brujon", "target": "Claquesous", "value": 1 },
      { "source": "Brujon", "target": "Montparnasse", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Bossuet", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Joly", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Grantaire", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Bahorel", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Courfeyrac", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Gavroche", "value": 1 },
      { "source": "Mme.Hucheloup", "target": "Enjolras", "value": 1 }
    ]
  }
    ;
  // genera un Hex color code che inizia con #0 (in modo che i colori siano tutti freddi)
  function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color + "";
  }

  //genera un array di colori
  function getArrayColori(n) {
    let arrayColori = [];
    for (let i = 0; i < n; i++) {
      arrayColori.push(getRandomColor());
    }
    return arrayColori;
  }


  // creo i nodi invisibili e li collego a tutti i nodi del loro cluster
  function primo() {

    var comandi = document.getElementById('comandi');

    comandi.innerHTML = 'Collision <input id="collision" step="1" type="range" min="0" max="50" value="20" />distanza nodi invisibili <input id="distance" step="1" type="range" min="0" max="1000" value="600" /><button id="invisibili" style="width: 200px; ">mostra/nascondi invisibili</button>'

    var w = window.innerWidth - 100;
    var h = window.innerHeight - 100;
    var svg = d3.select("svg").attr("width", w).attr("height", h);
    var width = svg.attr("width");
    var height = svg.attr("height");

    var nodiDaVedere = [...graph.nodes];
    var linkDaVedere = [...graph.links];



    var cluster_name = [];
    nodiDaVedere.forEach(function (d) {
      cluster_name.push(d.group);
    })
    var unique_cluster_name = [...new Set(cluster_name)];
    var lista_nodi_invisibili = [];
    unique_cluster_name.forEach(function (d) {
      var lista_nodi_cluster = [];

      nodiDaVedere.push({ "name": "invisibile" + d, "group": d });
      lista_nodi_invisibili.push("invisibile" + d)
      nodiDaVedere.forEach(function (s) {

        if (s.group == d) {
          lista_nodi_cluster.push(s.name)
        }

      });
      lista_nodi_cluster.forEach(function (z) {
        linkDaVedere.push({ "source": "invisibile" + d, "target": z, "value": 1 })
      });


    });
    // collego tutti i nodi invisibili tra di loro

    for (i = 0; i < lista_nodi_invisibili.length - 1; i++) {
      for (j = 1; j < lista_nodi_invisibili.length; j++) {
        linkDaVedere.push({ "source": lista_nodi_invisibili[i], "target": lista_nodi_invisibili[j], "value": 0 })
        linkDaVedere.push({ "source": lista_nodi_invisibili[j], "target": lista_nodi_invisibili[i], "value": 0 })
      }
    };

    let collisionNode = d3.forceCollide().radius(function (d) { if (d.name.includes("invisibile")) return 0; else return 20; })
    let distanceForceLink = d3.forceLink()
      .id(function (d) {
        return d.name;
      })
      .distance(function (d) {
        if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 600; }
        else {
          if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
            return -10;
          } else {
            return 0;
          }
        }
      })
      .strength(function (d) {
        if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.2; }
        else {
          if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
            return 0.3;
          } else {
            return 0;
          }
        }
      })
      .links(linkDaVedere)

    var simulation = d3
      .forceSimulation(nodiDaVedere)
      .force(
        "link",
        distanceForceLink
      )
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force('collision', collisionNode)
      .on("tick", ticked);

    var link = svg
      .append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(linkDaVedere)
      .enter()
      .append("line")
      .attr("class", function (d) {
        if (d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) {
          return 'invisibile'
        } else {
          return 'normale'
        }
      })
      .attr("stroke-width", function (d) {
        if (d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) return 4; else return 3;
      });
    var colori_array = getArrayColori(unique_cluster_name.length);
    var node = svg
      .append("g")
      .attr("class", "nodes")
      .selectAll("circle")
      .data(nodiDaVedere)
      .enter()
      .append("circle")
      .attr("class", function (d) {
        if (d.name.includes("invisibile")) {
          return 'invisibile'
        } else {
          return 'normale'
        }
      })
      .attr("r", function (d) { if (d.name.includes("invisibile")) return 10; else return 8 })
      .attr("fill", function (d) { if (d.name.includes("invisibile")) return 'red'; else return colori_array[d.group] })
      .call(
        d3
          .drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended)
      );

    node.exit().remove();


    function ticked() {
      node.attr("cx", function (d) { return d.x = Math.max(50, Math.min(width - 50, d.x)); })
        .attr("cy", function (d) { return d.y = Math.max(50, Math.min(height - 50, d.y)); });

      link.attr("x1", function (d) { return d.source.x; })
        .attr("y1", function (d) { return d.source.y; })
        .attr("x2", function (d) { return d.target.x; })
        .attr("y2", function (d) { return d.target.y; });
    }

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    d3.select('#invisibili').on('click', function () {
      var css = 'circle.invisibile { fill: none; }  line.invisibile {    stroke: none;  }',
        head = document.head || document.getElementsByTagName('head')[0],
        style = document.createElement('style');


      if (head.childNodes.length < 6) {
        head.appendChild(style);
        style.type = 'text/css';
        style.appendChild(document.createTextNode(css));
      } else {
        head.removeChild(head.lastChild);
      }

      /*     setTimeout(function (){head.removeChild(head.lastChild);},1000); */
    })

    d3.select('#collision').on('click', function () {
      collisionNode.radius(this.value)
      simulation.alpha(0.5).restart();
    })

    d3.select('#distance').on('click', function () {
      const valore = this.value;
      distanceForceLink.distance(function (d) {
        if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return valore; }
        else {
          if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
            return -10;
          } else {
            return 0;
          }
        }
      })
      simulation.alpha(0.5).restart();
    })
  }

  function secondo() {

    var comandi = document.getElementById('comandi');
    
    comandi.innerHTML = ''

    var nodiDaVedere = [...graph.nodes];
    var linkDaVedere = [...graph.links];

    var w = window.innerWidth - 100;
    var h = window.innerHeight - 100;
    var svg = d3.select("svg").attr("width", w).attr("height", h);
    var width = svg.attr("width");
    var height = svg.attr("height");

    var circleCoord = function (circle, node, index, num_nodes) {
      var circumference = circle.node().getTotalLength();
      var pointAtLength = function (l) { return circle.node().getPointAtLength(l) };
      var sectionLength = (circumference) / num_nodes;
      var position = sectionLength * index + sectionLength / 2;
      return pointAtLength(circumference - position)
    }
    function getPosition(force) {
      return force.nodes().map(function (node) {
        return {
          name: node.name,
          group: node.group,
          x: node.x,
          y: node.y
        }
      })
    }

    function circle1(cx, cy, myr) {

      return "M" + cx + "," + cy + " " +
        "m" + -myr + ", 0 " +
        "a" + myr + "," + myr + " 0 1,0 " + myr * 2 + ",0 " +
        "a" + myr + "," + myr + " 0 1,0 " + -myr * 2 + ",0Z";
    }

    var svg = d3.select("svg");
    var width = svg.attr("width");
    var height = svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory10);

    var nodes = [],
      links = [];


    var simulation = d3.forceSimulation()
      .force("link", d3.forceLink().distance(200).strength(.6).id(function (d) {
        return d.name;
      }).distance(function (d) {
        if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return -20; }
        else {
          if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
            return 20;
          } else {
            if (d.source.group == d.target.group) { return 0; } else {
              return 0;
            }
          }
        }
      })
        .strength(function (d) {
          if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.3; }
          else {
            if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
              return 0;
            } else {
              if (d.source.group == d.target.group) { return 0 } else {
                return 0;
              }
            }
          }
        }))
      .force("charge", d3.forceManyBody())
      .force("x", d3.forceX(width / 2))
      .force("y", d3.forceY(height / 2))
      .force('collision', d3.forceCollide().radius(function (d) { ; if (d.name.includes("invisibile")) return 200; else return 40; }))
      .on("tick", ticked);




    var cluster_name = [];
    nodiDaVedere.forEach(function (d) {
      cluster_name.push(d.group);
    })
    var unique_cluster_name = [...new Set(cluster_name)];
    var lista_nodi_invisibili = unique_cluster_name.map(d => {
      return { "name": "invisibile" + d, "group": d };
    });
    /*     lista_nodi_invisibili=[{ "name": "invisibile" + 1, "group": 1 },{ "name": "invisibile" + 2, "group": 2 }] */

    allNodes = nodiDaVedere.map(node => {
      return createNode(node.name, node.group)
    })

    nodes = lista_nodi_invisibili.map(node => {
      return createNode(node.name, node.group)
    })



    var colori_array = getArrayColori(unique_cluster_name.length);

    var a = createNode('A', 100);

    start();

    function getIndexGroup(groups, d) {
      for (let i = 0; i < groups.length; i++) {
        if (groups[i].key == d) return groups[i];
      }
    }

    function decisiNumeroNodiInvisibili(n) {
      return Math.floor(Math.log(n + 2.7) * 20)
      /* if (n<4) return 30;
      else if (n<7) return 40;
      else if (n<12) return 60;
      else return 80; */
    }

    var groups = d3.nest().key(function (d) { return d.group; }).entries(nodiDaVedere);

    setTimeout(function () {
      var coordinateCentroNodiPosizione = simulation.nodes().map(function (d) {
        return [d.x, d.y, d.group];
      })



      coordinateCentroNodiPosizione.forEach(function (d) {
        var x = d[0];
        var y = d[1];
        var j = d[2];

        const gruppo = getIndexGroup(groups, j)


        var nNodiGroupCluster = decisiNumeroNodiInvisibili(gruppo.values.length);

        var pathCircle = circle1(x, y, nNodiGroupCluster * 1.5);
        var circle = svg.append("path")
          .attr("d", pathCircle)
          .style("fill", "#f5f5f5")
          .style("opacity", 0.5);
        var length = circle.node().getTotalLength();
        for (i = 0; i < nNodiGroupCluster; i++) {
          nodo = createNode(String(i) + 'groupCluster' + String(j), 100);
          var coord = circleCoord(circle, nodo, i, nNodiGroupCluster)
          nodo.x = coord.x
          nodo.y = coord.y
          nodes.push(...[nodo])
          if (i > 0) {
            var link = { source: String(i - 1) + 'groupCluster' + String(j), target: String(i) + 'groupCluster' + String(j) }
            links.push(...[link])
          }
          if (i == nNodiGroupCluster - 1) {
            var link2 = { source: String(i) + 'groupCluster' + String(j), target: String(0) + 'groupCluster' + String(j) }
            links.push(...[link2])
          }
        };
        circle.remove();
      })

      simulation
        .force(
          "link",
          d3.forceLink()
            .id(function (d) {
              return d.name;
            })
            .distance(function (d) {
              if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return -100; }
              else {
                if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
                  return 100;
                } else {
                  if (d.source.group == d.target.group) { return -120; } else {
                    return 0;
                  }
                }
              }
            })
            .strength(function (d) {
              if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.2; }
              else {
                if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
                  return 0.6;
                } else {
                  if ((d.source.group == d.target.group) && (d.source.name.includes('groupCluster'))) { return 1 } else {
                    return 0;
                  }
                }
              }
            }))

        // use forceX and forceY instead to change the relative positioning
        // .force("centering", d3.forceCenter(width/2, height/2))
        .force("charge", d3.forceManyBody().strength(function (d) {
          if (d.name.includes("groupCluster")) return -50; else return -80;
        }))
        .force('collision', d3.forceCollide().radius(function (d) { if (d.name.includes("groupCluster")) return 8; else return 10; }))
        .on("tick", ticked);
      //nodes.push(...[a]);
      start();
    }, 1000);

    function getNodeGroup(group, listaNodi) {
      for (var i = 0; i < listaNodi.length; i++) {
        if (listaNodi[i].group == group) { return listaNodi[i]; }
      }
    }

    setTimeout(function () {
      var coordinateCentroNodiPosizione = [];
      simulation.nodes().forEach(function (d) {
        if (d.name.includes("invisibile")) {
          coordinateCentroNodiPosizione.push({ x: d.x, y: d.y, group: d.group });
        }
      });



      nodiDaVedere.forEach(d => {
        const centro = getNodeGroup(d.group, coordinateCentroNodiPosizione);
        const offset = 40;
        d.x = centro.x + (Math.random() * offset);
        d.y = centro.y + (Math.random() * offset);

        nodes.push(d);
      })

      links.push(...linkDaVedere)

      /*       d3.range(50).forEach(function (d) {
              var ny = coordinateCentroNodiPosizione[0].y + (Math.random() * 5);
              var nx = coordinateCentroNodiPosizione[0].x + (Math.random() * 5);
              nodes.push({ name: String(d), group: 0, x: nx, y: ny });
            }) */

      start2();
    }, 3000);



    function createNode(nome, group) {
      return { "name": nome, "x": width / 2, "y": height / 2, group }
    }

    var fase2 = false;

    function start() {

      var nodeElements = svg.selectAll(".node").data(nodes, function (d) { return d.id });


      nodeElements.enter()
        .append("circle")
        .attr("class", function (d) { return "node " + d.id; })
        .attr("r", function (d) {
          if (d.name.includes("invisibile")) {
            return 10;
          } else if (d.name == 'A') {
            return 20;
          } else {
            return 8
          }
        })
        .attr("fill", function (d) { if (d.name.includes("invisibile")) return "red"; else return colori_array[d.group] })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

      nodeElements.exit().remove();

      var linkElements = svg.selectAll(".link").data(links);
      linkElements.enter().insert("line", ".node").attr("class", "link");
      linkElements.exit().remove();

      simulation.nodes(nodes)
      simulation.force("link").links(links)
      simulation.restart();
    }

    function start2() {


      var nodeElements = svg.selectAll(".node").data(nodes, function (d) { return d.id });


      nodeElements.enter()
        .append("circle")
        .attr("class", function (d) { return "node " + d.id; })
        .attr("r", function (d) {
          if (d.name.includes("invisibile")) {
            return 10;
          } else if (d.name == 'A') {
            return 20;
          } else {
            return 8
          }
        })
        .attr("fill", function (d) { if (d.name.includes("invisibile")) return "red"; else return colori_array[d.group] })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

      nodeElements.exit().remove();

      var linkElements = svg.selectAll(".link").data(links);
      linkElements.enter().insert("line", ".node").attr("class", "link");
      linkElements.exit().remove();

      simulation.nodes(nodes)
      simulation.force("link").links(links)
      simulation.restart();
    }

    /*     function tick() {
          var nodeElements = svg.selectAll(".node");
          var linkElements = svg.selectAll(".link");
    
          nodeElements.attr("cx", function (d, i) { return d.x; })
            .attr("cy", function (d) { return d.y; })
    
          linkElements.attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });
    
    
        } */

    function ticked() {

      var nodeElements = svg.selectAll(".node");
      var linkElements = svg.selectAll(".link");

      nodeElements.attr("cx", function (d) {
        if (d.name.includes("groupCluster")) {
          return d.x
        }
        return d.x = Math.max(50, Math.min(width - 50, d.x));
      })
        .attr("cy", function (d) {
          if (d.name.includes("groupCluster")) {
            return d.y
          }
          return d.y = Math.max(50, Math.min(height - 50, d.y));
        });

      linkElements.attr("x1", function (d) { return d.source.x; })
        .attr("y1", function (d) { return d.source.y; })
        .attr("x2", function (d) { return d.target.x; })
        .attr("y2", function (d) { return d.target.y; });
    }

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

  }

  function terzo() {

    var comandi = document.getElementById('comandi');
    
    comandi.innerHTML = ''

    var nodiDaVedere = [...graph.nodes];
    var linkDaVedere = [...graph.links];

    var w = window.innerWidth - 100;
    var h = window.innerHeight - 100;
    var svg = d3.select("svg").attr("width", w).attr("height", h);
    var width = svg.attr("width");
    var height = svg.attr("height");

    function decisiNumeroNodiInvisibili(n) {
    if (n < 3) return 5;
    else if (n < 5) return 6;
    else if (n < 11) return 7;
    else return 8;
  }


  // creo i nodi invisibili e li collego a tutti i nodi del loro cluster
  var cluster_name = [];
  nodiDaVedere.forEach(function (d) {
    cluster_name.push(d.group);
  })
  var unique_cluster_name = [...new Set(cluster_name)];
  var lista_nodi_invisibili = [];

  function getIndexGroup(groups, d) {
    for (let i = 0; i < groups.length; i++) {
      if (groups[i].key == d) return groups[i];
    }
  }

  var groups = d3.nest().key(function (d) { return d.group; }).entries(nodiDaVedere);
  unique_cluster_name = groups.map(function (d) {
    return parseInt(d.key)
  });

  const invisibleNode = [];

  unique_cluster_name.forEach(function (d) {
    const nameInvisibleNode = "invisibile" + d;
    invisibleNode.push(nameInvisibleNode)
    nodiDaVedere.unshift({ "name": nameInvisibleNode, "group": d });
  });
  invisibleNode.forEach(function (j) {
    invisibleNode.forEach(function (i) {
      if (i != j) {
        linkDaVedere.push({ "source": i, "target": j, "value": 0 });
      }
    })
  })

  // collego tutti i nodi invisibili tra di loro


  var simulation = d3
    .forceSimulation(nodiDaVedere)
    .force(
      "link",
      d3.forceLink()
        .id(function (d) {
          return d.name;
        })
        .distance(function (d) {
          if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 600; }
          else {
            if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
              return 100;
            } else {
              if (d.source.group == d.target.group) { return 0; } else {
                return 0;
              }
            }
          }
        })
        .strength(function (d) {
          if (d.source.name.includes("invisibile") && d.target.name.includes("invisibile")) { return 0.2; }
          else {
            if ((d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) && d.source.group == d.target.group) {
              return 0.6;
            } else {
              if (d.source.group == d.target.group) { return 0.1 } else {
                return 0;
              }
            }
          }
        })
        .links(linkDaVedere)
    )
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(function (d) {
      if (d.name.includes("invisibile")) return 0;
      else return 20;
    }))
    .on("tick", ticked);

  function raggioGroup(group) {
    for (let i = 0; i < groups.length; i++) {
      if (groups[i].key == group) { return (groups[i].values.length * 5)+50; }
    }
  }

  var link = svg
    .append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(linkDaVedere)
    .enter()
    .append("line")
    .attr("stroke-width", function (d) {
      if (d.source.name.includes("invisibile") || d.target.name.includes("invisibile")) return 0; else return 3;
    });
  var colori_array = getArrayColori(unique_cluster_name.length);
  var node = svg
    .append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(nodiDaVedere)
    .enter()
    .append("circle")
    .attr("r", function (d) {
      if (d.name.includes("invisibile")) {
        return raggioGroup(d.group);
      } else{
        return 8;
      }
    })
    .attr("fill", function (d) { if (d.name.includes("invisibile")) return "rgba(198, 45, 205, 0.1)"; else return colori_array[d.group] })
;



  /*   var groupPath = function (d) {
      return "M" +
        d3.polygonHull(d.values.map(i => { return [i[0], i[1]] })).join('L')
        + "Z";
    }; */
  //---------------
  function distanzaCentro(x2, y2, x1, y1) {
    return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))
  }
  function getCentroGruppo(groupId, invisibili) {
    for (let i = 0; i < invisibili.length; i++) {
      if (invisibili[i].group == groupId) {
        return invisibili[i]
      }
    }
  }
  //-------------



  function ticked() {

    const invisibili = [];
    node.attr("cx", function (d) {
      if (d.name.includes("invisibile"))
        invisibili.push({ group: d.group, x: d.x, y: d.y });
    });

    const offset = 40;
        

    node.attr("cx", function (d) {
      const coordinateCentro = getCentroGruppo(d.group, invisibili);
      if (distanzaCentro(d.x, d.y, coordinateCentro.x, coordinateCentro.y) > raggioGroup(d.group)) {
        return d.x = d.x = coordinateCentro.x + (Math.random() * offset);
      } else {
        return d.x;
      }
    })
      .attr("cy", function (d) {
        const coordinateCentro = getCentroGruppo(d.group, invisibili);
        if (distanzaCentro(d.x, d.y, coordinateCentro.x, coordinateCentro.y) > raggioGroup(d.group)) {
          return d.y = coordinateCentro.y + (Math.random() * offset);
        } else {
          return d.y;
        }
      }
      );

    node.attr("cx", function (d) {

      return d.x = Math.max(50, Math.min(width - 50, d.x));
    })
      .attr("cy", function (d) { return d.y = Math.max(50, Math.min(height - 50, d.y)); });

    link.attr("x1", function (d) { return d.source.x; })
      .attr("y1", function (d) { return d.source.y; })
      .attr("x2", function (d) { return d.target.x; })
      .attr("y2", function (d) { return d.target.y; });



  }

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
  }

  primo();

  d3.selectAll("input[name='grafo']").on("change", function () {
    switch (this.value) {
      case "1":
        d3.select("svg").remove();
        d3.select("#contenitore").append('svg')
        primo();
        break;
      case "2":
        d3.select("svg").remove();
        d3.select("#contenitore").append('svg')
        secondo();
        break;
      case "3":
        d3.select("svg").remove();
        d3.select("#contenitore").append('svg')
        terzo();
        break;
    }
  });
</script>